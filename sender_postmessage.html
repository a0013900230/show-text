<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>LabVIEW UTF-8 輸入 v2.7</title>
  <style>
    body {
      font-family: 'Microsoft JhengHei', Arial, sans-serif;
      background: white;
      padding: 0;
      margin: 0;
      overflow: hidden; /* 隱藏卷軸 */
    }
    html {
      overflow: hidden; /* 隱藏HTML卷軸 */
    }
    input[type="text"] {
      width: 372px;
      height: 30px;
      padding: 5px 10px;
      border: 1px solid #ccc;
      font-size: 16px;
      font-family: inherit;
      box-sizing: border-box;
      text-align: center; /* 文字置中對齊 */
    }
    input[type="text"]:focus {
      outline: none;
      border-color: #ccc;
    }
    /* 隱藏 placeholder 文字 */
    input[type="text"]::placeholder {
      color: transparent;
    }
    input[type="text"]::-webkit-input-placeholder {
      color: transparent;
    }
    input[type="text"]::-moz-placeholder {
      color: transparent;
    }
    input[type="text"]:-ms-input-placeholder {
      color: transparent;
    }
    /* 隱藏IE瀏覽器的清除按鈕 - 更強力版本 */
    input[type="text"]::-ms-clear {
      display: none !important;
      width: 0 !important;
      height: 0 !important;
      visibility: hidden !important;
      opacity: 0 !important;
    }
    /* 隱藏WebKit瀏覽器的清除按鈕 */
    input[type="text"]::-webkit-search-cancel-button {
      display: none !important;
      -webkit-appearance: none !important;
      visibility: hidden !important;
      opacity: 0 !important;
    }
    /* 隱藏所有瀏覽器的清除按鈕 */
    input[type="text"]::-ms-reveal {
      display: none !important;
      visibility: hidden !important;
      opacity: 0 !important;
    }
    /* 只禁用拖動，保留文字反白功能 */
    body {
      -webkit-touch-callout: none !important;
      -webkit-tap-highlight-color: transparent !important;
    }
    /* 允許所有文字選擇和反白 */
    * {
      -webkit-user-select: text !important;
      -moz-user-select: text !important;
      -ms-user-select: text !important;
      user-select: text !important;
    }
    #dataValue {
      display: none;
    }
  </style>
</head>
<body>
  <input 
    type="text" 
    id="userInput" 
    placeholder=""
    onpaste="handlePaste(event)"
    onkeydown="handleKeyDown(event)"
    onkeyup="handleKeyUp(event)"
    oninput="handleInput(event)"
    onchange="handleChange(event)"
    oncontextmenu="return false;"
  />
  
  <!-- 隱藏的資料容器，供 LabVIEW 讀取 -->
  <div id="dataValue"></div>

  <script>
    // 頁面載入狀態管理
    var isLoaded = false;
    var pendingScripts = [];

    // 公共執行器：在 DOM 載入前，將指令放入隊列
    function executeCommand(script) {
      if (isLoaded) {
        // DOM 已載入，立即執行
        try {
          // 包裝在匿名函數中執行，避免污染全域作用域
          (function() {
            try {
              eval(script);
            } catch (innerError) {
              // 內部錯誤：可能是 atob 失敗等，嘗試使用安全函數
              if (typeof console !== 'undefined' && console.warn) {
                console.warn('Script execution error (inner):', innerError.message);
              }
              // 如果錯誤包含 "atob" 或 "Invalid character"，嘗試用安全方式處理
              if (innerError.message && 
                  (innerError.message.indexOf('atob') !== -1 || 
                   innerError.message.indexOf('Invalid character') !== -1)) {
                // 嘗試提取引數並使用 setInputFromAtob
                var match = script.match(/setInput\s*\(\s*atob\s*\(\s*['"]([^'"]+)['"]\s*\)\s*\)/);
                if (match && match[1]) {
                  setInputFromAtob(match[1]);
                }
              }
            }
          })();
        } catch (e) {
          // 外層錯誤捕獲
          if (typeof console !== 'undefined' && console.error) {
            console.error('Command execution error (outer):', e);
          }
        }
      } else {
        // DOM 未載入，放入隊列
        pendingScripts.push(script);
      }
    }

    var inputBox = document.getElementById('userInput');
    var dataDiv = document.getElementById('dataValue');

    // trim 函式 (相容舊版IE)
    function trim(str) {
      if (typeof str.trim !== 'undefined') {
        return str.trim();
      } else {
        return str.replace(/^\s+|\s+$/g, '');
      }
    }

    // 設定文字內容的相容函式 (相容舊版IE)
    function setTextContent(element, text) {
      if (element.textContent !== undefined) {
        element.textContent = text;
      } else {
        element.innerText = text;
      }
    }

    // Base64 編碼函式 (相容舊版IE)
    function base64Encode(str) {
      if (typeof btoa !== 'undefined') {
        return btoa(unescape(encodeURIComponent(str)));
      } else {
        var chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=';
        var result = '';
        var i = 0;
        str = unescape(encodeURIComponent(str));
        while (i < str.length) {
          var a = str.charCodeAt(i++);
          var b = i < str.length ? str.charCodeAt(i++) : 0;
          var c = i < str.length ? str.charCodeAt(i++) : 0;
          var bitmap = (a << 16) | (b << 8) | c;
          result += chars.charAt((bitmap >> 18) & 63);
          result += chars.charAt((bitmap >> 12) & 63);
          result += i - 2 < str.length ? chars.charAt((bitmap >> 6) & 63) : '=';
          result += i - 1 < str.length ? chars.charAt(bitmap & 63) : '=';
        }
        return result;
      }
    }

    // Base64 解碼函式 (相容舊版IE)
    function base64Decode(str) {
      if (typeof atob !== 'undefined') {
        try {
          var decoded = decodeURIComponent(escape(atob(str)));
          // 移除 null 字元和尾端空白
          return decoded.replace(/\0/g, '').trim();
        } catch (e) {
          return '';
        }
      } else {
        var chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=';
        var result = '';
        var i = 0;
        str = str.replace(/[^A-Za-z0-9+/=]/g, '');
        while (i < str.length) {
          var encoded1 = chars.indexOf(str.charAt(i++));
          var encoded2 = chars.indexOf(str.charAt(i++));
          var encoded3 = chars.indexOf(str.charAt(i++));
          var encoded4 = chars.indexOf(str.charAt(i++));
          var bitmap = (encoded1 << 18) | (encoded2 << 12) | (encoded3 << 6) | encoded4;
          result += String.fromCharCode((bitmap >> 16) & 255);
          if (encoded3 !== 64) result += String.fromCharCode((bitmap >> 8) & 255);
          if (encoded4 !== 64) result += String.fromCharCode(bitmap & 255);
        }
        try {
          var decoded = decodeURIComponent(escape(result));
          // 移除 null 字元和尾端空白
          return decoded.replace(/\0/g, '').trim();
        } catch (e) {
          // 移除 null 字元和尾端空白
          return result.replace(/\0/g, '').trim();
        }
      }
    }

    // 方法1: 使用 postMessage 通訊
    function sendDataToLabVIEW() {
      var text = inputBox.value;
      var encoded = text ? base64Encode(text) : '';
      
      // 發送資料給 LabVIEW
      if (window.chrome && window.chrome.webview && window.chrome.webview.postMessage) {
        window.chrome.webview.postMessage({
          type: 'inputData',
          data: encoded
        });
      } else if (window.external && typeof window.external.msObjectForJavascript !== 'undefined') {
        // 相容 IE 的 postMessage
        window.external.msObjectForJavascript('data', encoded);
      }
    }

    // 方法2: 更新隱藏 div 的內容（供 LabVIEW 用 Document.getElementById 讀取）
    function updateDataDiv() {
      setTextContent(dataDiv, inputBox.value);
      dataDiv.setAttribute('data-text', inputBox.value);
    }

    // 方法3: 儲存到 window 全域變數（供 execScript 讀取）
    function updateGlobal() {
      window.labviewData = inputBox.value;
    }

    // 監聽輸入變化 (使用舊版IE相容方式)
    if (inputBox.addEventListener) {
      inputBox.addEventListener('input', function() {
        sendDataToLabVIEW();
        updateDataDiv();
        updateGlobal();
      });
    } else if (inputBox.attachEvent) {
      inputBox.attachEvent('onpropertychange', function() {
        if (event.propertyName === 'value') {
          sendDataToLabVIEW();
          updateDataDiv();
          updateGlobal();
        }
      });
    }

    // 支援 Enter 鍵更新 (使用舊版IE相容方式)
    if (inputBox.addEventListener) {
      inputBox.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          sendDataToLabVIEW();
          updateDataDiv();
          updateGlobal();
        }
      });
    } else if (inputBox.attachEvent) {
      inputBox.attachEvent('onkeypress', function(e) {
        if (e.keyCode === 13) { // Enter 鍵
          sendDataToLabVIEW();
          updateDataDiv();
          updateGlobal();
        }
      });
    }

    // 提供清除功能（可由 LabVIEW 呼叫）
    function clearInput() {
      inputBox.value = '';
      setTextContent(dataDiv, '');
      window.labviewData = '';
      // 發送清除訊息給 LabVIEW
      sendDataToLabVIEW();
    }

    // 提供設定功能（可由 LabVIEW 寫入）
    function setInput(text) {
      // 確保 inputBox 已存在
      if (!inputBox) {
        // 如果 DOM 還沒載入，將指令放入隊列
        // 使用 JSON.stringify 來安全地處理特殊字元和引號
        executeCommand('setInput(' + JSON.stringify(text) + ');');
        return;
      }
      
      // 處理 undefined 或 null
      if (text === undefined || text === null) {
        inputBox.value = '';
        sendDataToLabVIEW();
        updateDataDiv();
        updateGlobal();
        return;
      }
      
      // 確保是字串
      if (typeof text !== 'string') {
        text = String(text);
      }
      
      // 如果接收到的是 base64 編碼的字串，需要先解碼
      var decodedText = text;
      
      // 檢查是否可能是 base64（但排除直接文字內容）
      if (text && text.length > 0) {
        // 嘗試解碼 base64
        try {
          var testDecoded = base64Decode(text);
          // 如果解碼成功且有內容，使用解碼後的內容
          if (testDecoded && testDecoded.length > 0) {
            decodedText = testDecoded;
          }
        } catch (e) {
          // 解碼失敗，使用原始內容
          decodedText = text;
        }
      }
      
      inputBox.value = decodedText;
      sendDataToLabVIEW();
      updateDataDiv();
      updateGlobal();
    }

    // 安全的 setInput 包裝函數，供 LabVIEW 使用（自動處理 atob 錯誤）
    function setInputSafe(base64OrText) {
      try {
        // 首先嘗試直接使用（可能是已解碼的文字）
        setInput(base64OrText);
      } catch (e) {
        // 如果失敗，嘗試解碼
        try {
          var decoded = base64Decode(base64OrText);
          setInput(decoded);
        } catch (e2) {
          // 如果解碼也失敗，直接使用原始內容
          setInput(base64OrText);
        }
      }
    }

    // 帶 atob 包裝的安全函數（供 LabVIEW 直接調用）
    function setInputFromAtob(base64String) {
      try {
        if (typeof atob !== 'undefined') {
          var decoded = atob(base64String);
          setInput(decoded);
        } else {
          // 使用自定義的 base64Decode
          var decoded = base64Decode(base64String);
          setInput(decoded);
        }
      } catch (e) {
        // atob 失敗（不是有效 base64），直接作為文字使用
        setInput(base64String);
      }
    }

    // 提供重置功能（供 LabVIEW 重新導航前調用）
    function resetForNavigation() {
      // 清除所有狀態
      inputBox.value = '';
      
      // 清除 hash
      if (window.history && window.history.replaceState) {
        window.history.replaceState(null, null, window.location.pathname + window.location.search);
      } else {
        window.location.hash = '';
      }
      
      // 清除資料容器
      setTextContent(dataDiv, '');
      window.labviewData = '';
      
      // 重新聚焦到輸入框
      inputBox.focus();
    }

    // 檢查 URL hash 並填入內容（顯示模式）
    function checkUrlHash() {
      var hash = window.location.hash;
      if (hash && hash.length > 1) {
        // 移除 # 符號
        var base64Content = hash.substring(1);
        if (base64Content) {
          try {
            // 解碼 base64 內容
            var decodedText = base64Decode(base64Content);
            if (decodedText) {
              // 填入輸入框
              inputBox.value = decodedText;
              // 更新其他資料容器
              updateDataDiv();
              updateGlobal();
              
              return true; // 表示是顯示模式
            }
          } catch (e) {
            // 相容舊版瀏覽器，避免 console 未定義錯誤
            if (typeof console !== 'undefined' && console.log) {
              console.log('Base64 decode error:', e);
            }
          }
        }
      }
      return false; // 表示是輸入模式
    }

    // 處理 WebView2 postMessage 通訊
    function handlePostMessage(event) {
      try {
        var data = event.data;
        var decodedText = '';
        
        // 檢查是否為 JSON 格式
        if (typeof data === 'object' && data !== null) {
          // JSON 格式：取得 data 欄位
          if (data.data) {
            decodedText = base64Decode(data.data);
          } else if (data.text) {
            // 如果是直接文字
            decodedText = data.text;
          }
        } 
        // 檢查是否為純字串
        else if (data && typeof data === 'string') {
          // 解碼 base64 內容
          decodedText = base64Decode(data);
        }
        
        if (decodedText && decodedText !== null) {
          // 填入輸入框
          inputBox.value = decodedText;
          // 更新其他資料容器
          updateDataDiv();
          updateGlobal();
          
          // 發送回饋訊息給 WebView2
          if (window.chrome && window.chrome.webview) {
            window.chrome.webview.postMessage({
              type: 'contentLoaded',
              success: true,
              message: 'Content loaded successfully'
            });
          }
        }
      } catch (e) {
        // 相容舊版瀏覽器，避免 console 未定義錯誤
        if (typeof console !== 'undefined' && console.log) {
          console.log('PostMessage decode error:', e);
        }
        // 發送錯誤訊息給 WebView2
        if (window.chrome && window.chrome.webview) {
          window.chrome.webview.postMessage({
            type: 'contentLoaded',
            success: false,
            message: 'Error decoding content: ' + e.message
          });
        }
      }
    }

    // 處理貼上事件 (相容舊版IE)
    function handlePaste(event) {
      // 延遲執行以確保貼上內容已插入
      setTimeout(function() {
        sendDataToLabVIEW();
        updateDataDiv();
        updateGlobal();
      }, 10);
    }

    // 處理鍵盤按下事件 (支援所有快捷鍵)
    function handleKeyDown(event) {
      var keyCode = event.keyCode || event.which;
      var ctrlKey = event.ctrlKey || event.metaKey;
      
      // Ctrl+C (複製)
      if (ctrlKey && keyCode === 67) {
        // 允許預設行為
        return true;
      }
      
      // Ctrl+V (貼上)
      if (ctrlKey && keyCode === 86) {
        // 延遲執行以確保貼上內容已插入
        setTimeout(function() {
          sendDataToLabVIEW();
          updateDataDiv();
          updateGlobal();
        }, 10);
        return true;
      }
      
      // Ctrl+A (全選)
      if (ctrlKey && keyCode === 65) {
        // 允許預設行為
        return true;
      }
      
      // Delete 鍵
      if (keyCode === 46) {
        // 延遲執行以確保刪除已完成
        setTimeout(function() {
          sendDataToLabVIEW();
          updateDataDiv();
          updateGlobal();
        }, 10);
        return true;
      }
      
      // Backspace 鍵
      if (keyCode === 8) {
        // 延遲執行以確保刪除已完成
        setTimeout(function() {
          sendDataToLabVIEW();
          updateDataDiv();
          updateGlobal();
        }, 10);
        return true;
      }
      
      // 允許其他鍵的預設行為
      return true;
    }

    // 處理鍵盤放開事件
    function handleKeyUp(event) {
      // 延遲執行以確保所有鍵盤操作已完成
      setTimeout(function() {
        sendDataToLabVIEW();
        updateDataDiv();
        updateGlobal();
      }, 10);
    }

    // 處理輸入事件
    function handleInput(event) {
      sendDataToLabVIEW();
      updateDataDiv();
      updateGlobal();
    }

    // 處理內容變化事件
    function handleChange(event) {
      sendDataToLabVIEW();
      updateDataDiv();
      updateGlobal();
    }

    // 針對ActiveX Container的特殊處理
    function disableActiveXScroll() {
      // 完全禁用滾動事件
      document.onmousewheel = function() { return false; };
      document.onscroll = function() { return false; };
      
      // 禁用所有可能的滾動事件
      if (document.addEventListener) {
        document.addEventListener('wheel', function(e) { e.preventDefault(); }, false);
        document.addEventListener('scroll', function(e) { e.preventDefault(); }, false);
        document.addEventListener('touchmove', function(e) { e.preventDefault(); }, false);
      }
      
      // 針對ActiveX Container的特殊處理
      document.onmousedown = function(e) {
        var event = e || window.event;
        var target = event.target || event.srcElement;
        
        // 只允許在輸入框內操作
        if (target === inputBox) {
          // 在輸入框內時，禁用所有滾動
          document.body.style.overflow = 'hidden';
          return true;
        }
        
        // 其他區域完全禁用
        return false;
      };
      
      document.onmouseup = function(e) {
        // 滑鼠放開時恢復滾動設定
        document.body.style.overflow = 'hidden';
        return false;
      };
      
      // 禁用右鍵選單
      document.oncontextmenu = function() { return false; };
      
      // 強制設定body樣式
      document.body.style.overflow = 'hidden';
      document.body.style.position = 'fixed';
      document.body.style.width = '100%';
      document.body.style.height = '100%';
    }

    // 初始化 (使用舊版IE相容方式)
    if (window.addEventListener) {
      window.addEventListener('load', function() {
        // 載入完成，設定旗標
        isLoaded = true;
        
        // 檢查是否為顯示模式
        var isDisplayMode = checkUrlHash();
        if (!isDisplayMode) {
          inputBox.focus();
        }
        disableActiveXScroll();
        
        // 執行所有積壓的命令
        while (pendingScripts.length > 0) {
          var script = pendingScripts.shift();
          try {
            eval(script);
          } catch (e) {
            if (typeof console !== 'undefined' && console.error) {
              console.error('Pending script execution error:', e);
            }
          }
        }
      });
      
      // 添加 WebView2 postMessage 監聽器
      window.addEventListener('message', handlePostMessage);
    } else if (window.attachEvent) {
      window.attachEvent('onload', function() {
        // 載入完成，設定旗標
        isLoaded = true;
        
        // 檢查是否為顯示模式
        var isDisplayMode = checkUrlHash();
        if (!isDisplayMode) {
          inputBox.focus();
        }
        disableActiveXScroll();
        
        // 執行所有積壓的命令
        while (pendingScripts.length > 0) {
          var script = pendingScripts.shift();
          try {
            eval(script);
          } catch (e) {
            if (typeof console !== 'undefined' && console.error) {
              console.error('Pending script execution error:', e);
            }
          }
        }
      });
      
      // 舊版瀏覽器的 postMessage 監聽
      window.attachEvent('onmessage', handlePostMessage);
    } else {
      window.onload = function() {
        // 載入完成，設定旗標
        isLoaded = true;
        
        // 檢查是否為顯示模式
        var isDisplayMode = checkUrlHash();
        if (!isDisplayMode) {
          inputBox.focus();
        }
        disableActiveXScroll();
        
        // 執行所有積壓的命令
        while (pendingScripts.length > 0) {
          var script = pendingScripts.shift();
          try {
            eval(script);
          } catch (e) {
            if (typeof console !== 'undefined' && console.error) {
              console.error('Pending script execution error:', e);
            }
          }
        }
      };
      
      // 備用 postMessage 監聽
      window.onmessage = handlePostMessage;
    }
  </script>
</body>
</html>
